# Story 1.10: Build Frontend Letter Preview and Export Interface

**Epic: 1 - Discovery Deficiency Analysis and Good Faith Letter Generation**

## Status
Draft

## Story
**As a** legal team member,
**I want** to preview and export Good Faith letters,
**so that** I can review before sending to opposing counsel.

## Acceptance Criteria
1: Create letter preview component with rich text display
2: Implement editing capabilities for letter customization
3: Add export functionality (PDF, Word formats)
4: Include version tracking for letter drafts
5: Implement email integration preparation

## Tasks / Subtasks
- [ ] Task 1: Create Letter Preview Component (AC: 1)
  - [ ] Create LetterPreview.tsx component with Material-UI Paper container
  - [ ] Implement rich text rendering for letter content sections
  - [ ] Add section-based structure (salutation, subject, body, deficiencies, conclusion)
  - [ ] Style with professional legal document formatting
  - [ ] Add loading states and error handling
  - [ ] Create unit tests for component rendering

- [ ] Task 2: Implement Letter Editing Interface (AC: 2)
  - [ ] Create LetterEditor.tsx component with inline editing capabilities
  - [ ] Implement section-based editing with content preservation
  - [ ] Add rich text editor integration (e.g., Quill or TipTap)
  - [ ] Create edit history tracking with version comparison
  - [ ] Implement save draft functionality with optimistic updates
  - [ ] Add validation for required letter sections
  - [ ] Create unit tests for editing functionality

- [ ] Task 3: Build Export Functionality (AC: 3)
  - [ ] Create LetterExportDialog.tsx component for format selection
  - [ ] Implement PDF export using existing backend endpoint
  - [ ] Implement Word export using existing backend endpoint
  - [ ] Add export progress indication with loading states
  - [ ] Handle export errors with user-friendly messages
  - [ ] Create download trigger with proper file naming
  - [ ] Add unit tests for export flows

- [ ] Task 4: Implement Version Tracking UI (AC: 4)
  - [ ] Create LetterVersionHistory.tsx component
  - [ ] Display version list with timestamps and authors
  - [ ] Implement version comparison view
  - [ ] Add restore previous version functionality
  - [ ] Create version selection interface
  - [ ] Add unit tests for version management

- [ ] Task 5: Create Email Integration Preparation (AC: 5)
  - [ ] Create EmailPreparation.tsx component
  - [ ] Build recipient selection/input interface
  - [ ] Add email subject line customization
  - [ ] Create attachment preview (letter + evidence)
  - [ ] Implement send confirmation dialog
  - [ ] Add email draft saving capability
  - [ ] Create unit tests for email preparation

- [ ] Task 6: Create Letter Management Page (AC: 1, 2, 3, 4, 5)
  - [ ] Create GoodFaithLetterPage.tsx as main container
  - [ ] Integrate all letter components in tabbed interface
  - [ ] Implement React Query for data fetching
  - [ ] Add WebSocket integration for real-time updates
  - [ ] Create responsive layout for mobile/tablet
  - [ ] Add comprehensive error boundaries
  - [ ] Create integration tests for full workflow

## Dev Notes

### Previous Story Insights
[Source: Story 1.9 completion notes]
- Good Faith Letter Agent successfully implemented with BMad framework
- Letter generation API endpoints available at `/api/agents/good-faith-letter/*`
- Database persistence implemented with SQLAlchemy models
- Export functionality supports PDF, DOCX, and HTML formats
- Letter customization service with versioning is ready
- WebSocket events established for real-time progress tracking

### Frontend Architecture Overview
[Source: architecture/frontend-architecture.md]
- **React 18+** with TypeScript for type safety
- **Material-UI (MUI) v5** as component library
- **React Query (TanStack Query)** for server state management
- **React Hook Form** with **Zod** for form validation
- **Socket.io Client** for WebSocket communication
- **Emotion** for CSS-in-JS styling
- **Vite** as build tool

### Component Structure
[Source: architecture/frontend-architecture.md#component-hierarchy]
The letter preview/export interface should follow the established component hierarchy:
```
GoodFaithLetterPage (Feature Component)
├── LetterPreview (Display Component)
├── LetterEditor (Form Component)
├── LetterVersionHistory (Display Component)
├── LetterExportDialog (Feedback Component)
└── EmailPreparation (Form Component)
```

### API Integration Details
[Source: Story 1.9 API endpoints + architecture/rest-api-spec.md]
Available endpoints for letter management:
- `POST /api/agents/good-faith-letter/generate-letter` - Generate new letter
- `GET /api/agents/good-faith-letter/preview/{letter_id}` - Get letter for preview
- `PUT /api/agents/good-faith-letter/customize/{letter_id}` - Save letter edits
- `POST /api/agents/good-faith-letter/finalize/{letter_id}` - Finalize letter
- `GET /api/agents/good-faith-letter/export/{letter_id}/{format}` - Export letter

### WebSocket Events
[Source: Story 1.9 WebSocket specifications]
Listen for these events:
- `letter:generation_started` - Letter generation begun
- `letter:draft_created` - Initial draft ready
- `letter:customization_applied` - Edit applied
- `letter:finalized` - Letter ready for sending
- `agent:task_progress` - Progress updates during operations

### Data Models
[Source: Story 1.9 + architecture/data-models-and-schema-changes.md]
```typescript
interface GeneratedLetter {
  id: string;
  report_id: string;
  case_name: string;
  jurisdiction: string;
  content: string;
  status: 'draft' | 'review' | 'approved' | 'finalized';
  version: number;
  agent_execution_id: string;
  created_at: string;
  updated_at?: string;
  approved_by?: string;
  approved_at?: string;
  edit_history: LetterEdit[];
}

interface LetterEdit {
  id: string;
  letter_id: string;
  version: number;
  editor_id: string;
  editor_name: string;
  section_edits: SectionEdit[];
  edit_timestamp: string;
  edit_notes?: string;
}
```

### UI Component Patterns
[Source: architecture/components.md]
Use these existing component patterns:
- **DocumentViewer** pattern for letter preview with sections
- **TabPanel** for organizing preview/edit/export/email sections
- **DataGrid** for version history display
- **ConfirmDialog** for export/send confirmations
- **LoadingOverlay** for long operations

### State Management
[Source: architecture/frontend-architecture.md#state-management]
```typescript
// Use React Query for server state
const { data: letter, isLoading } = useQuery({
  queryKey: ['letter', letterId],
  queryFn: () => api.goodFaithLetter.getLetter(letterId),
  refetchInterval: (data) => 
    data?.status === 'draft' ? 5000 : false,
});

// Use Context for letter editing state
const LetterEditContext = createContext<LetterEditContextValue | null>(null);
```

### Export Format Requirements
[Source: Story 1.9 export service implementation]
- **PDF**: Professional legal formatting with headers/footers
- **DOCX**: Editable format maintaining structure
- **HTML**: Web-friendly format (not exposed in UI initially)

### File Locations
[Source: architecture/unified-project-structure.md]
- Feature components: `src/features/GoodFaithLetter/`
  - `GoodFaithLetterPage.tsx`
  - `components/LetterPreview.tsx`
  - `components/LetterEditor.tsx`
  - `components/LetterVersionHistory.tsx`
  - `components/LetterExportDialog.tsx`
  - `components/EmailPreparation.tsx`
- API services: `src/services/api/goodFaithLetter.ts`
- Types: `src/types/goodFaithLetter.types.ts`
- Hooks: `src/hooks/useGoodFaithLetter.ts`
- Tests: Co-located in `__tests__/` directories

### Security Considerations
[Source: CLAUDE.md security requirements]
- Case isolation enforced through X-Case-ID header
- Letter access restricted by case permissions
- Edit history tracks user attribution
- Export actions logged for audit trail

### Testing

**Testing Standards:**
[Source: architecture/testing-strategy.md + architecture/frontend-architecture.md#testing]
- Use Jest + React Testing Library for component tests
- Mock API calls with MSW (Mock Service Worker)
- Test accessibility with jest-axe
- Coverage target: 80%+
- Co-locate tests in `__tests__/` directories

**Key Test Scenarios:**
- Letter preview renders all sections correctly
- Edit mode preserves unedited sections
- Version history shows correct sequence
- Export triggers download properly
- Email preparation validates recipients
- WebSocket updates trigger re-renders
- Error states display appropriately
- Mobile responsive layout works

**Component Testing Example:**
```typescript
describe('LetterPreview', () => {
  it('should render letter sections', async () => {
    render(
      <QueryClientProvider client={queryClient}>
        <LetterPreview letterId="123" />
      </QueryClientProvider>
    );
    
    await waitFor(() => {
      expect(screen.getByText('Re: Smith v. Jones')).toBeInTheDocument();
      expect(screen.getByText('Dear Counsel:')).toBeInTheDocument();
    });
  });
});
```

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-07-22 | 1.0 | Initial story creation based on Epic 1.10 | BMad Create-Next-Story Task |

## Dev Agent Record
### Agent Model Used


### Debug Log References


### Completion Notes List


### File List


## QA Results