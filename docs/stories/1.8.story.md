# Story 1.8: Create Good Faith Letter Template System

**Epic: 1 - Discovery Deficiency Analysis and Good Faith Letter Generation**

## Status
Draft

## Story
**As a** developer,
**I want** to implement a template system for Good Faith letters,
**so that** we can generate jurisdiction-appropriate letters.

## Acceptance Criteria
1: Create template storage and retrieval system
2: Implement template variables for dynamic content insertion
3: Support multiple letter formats (formal, informal, etc.)
4: Add template versioning for compliance tracking
5: Create default templates for common jurisdictions

## Tasks / Subtasks
- [ ] Task 1: Extend BMad Framework Template System for Good Faith Letters (AC: 1, 4)
  - [ ] Create `GoodFaithLetterTemplateLoader` class extending existing `TemplateLoader` from `Clerk/src/ai_agents/bmad_framework/template_loader.py`
  - [ ] Add support for jurisdiction-specific template loading
  - [ ] Implement template versioning mechanism in metadata
  - [ ] Add template validation for required sections and variables
  - [ ] Create unit tests for template loader functionality

- [ ] Task 2: Create Good Faith Letter Template Structure (AC: 2, 3)
  - [ ] Define standard template structure in YAML format
  - [ ] Implement variable placeholders for dynamic content:
    - [ ] Case information (names, numbers, dates)
    - [ ] Deficiency details (request numbers, descriptions)
    - [ ] Jurisdiction-specific legal language
    - [ ] Response deadlines and timeframes
  - [ ] Support conditional sections based on letter format (formal/informal)
  - [ ] Add validation rules for required variables

- [ ] Task 3: Implement Default Templates for Common Jurisdictions (AC: 5)
  - [ ] Create `good-faith-letter-federal.yaml` template
  - [ ] Create `good-faith-letter-california.yaml` template
  - [ ] Create `good-faith-letter-florida.yaml` template
  - [ ] Create `good-faith-letter-texas.yaml` template
  - [ ] Include jurisdiction-specific legal requirements and language

- [ ] Task 4: Build Letter Template Service (AC: 1, 3, 4)
  - [ ] Create `LetterTemplateService` in `Clerk/src/services/`
  - [ ] Implement template CRUD operations
  - [ ] Add template selection logic based on jurisdiction
  - [ ] Create template rendering method with variable substitution:
    - [ ] Accept DeficiencyReport as input data
    - [ ] Map deficiency items to template's detailed_deficiencies sections
    - [ ] Replace {{VARIABLE}} placeholders with actual values
    - [ ] Handle repeatable sections for multiple deficiency items
  - [ ] Implement template caching for performance
  - [ ] Add comprehensive unit tests

- [ ] Task 5: Create API Endpoints for Template Management (AC: 1)
  - [ ] Add new endpoints to existing `Clerk/src/api/deficiency_endpoints.py`:
    - [ ] `GET /api/templates/good-faith-letters` - List available templates
    - [ ] `GET /api/templates/good-faith-letters/{template_id}` - Get specific template
    - [ ] `POST /api/templates/good-faith-letters` - Create custom template
    - [ ] `PUT /api/templates/good-faith-letters/{template_id}` - Update template
  - [ ] Register the template routes in the existing deficiency router
  - [ ] Implement proper case isolation and permissions
  - [ ] Add request/response validation with Pydantic models
  - [ ] Create API tests

- [ ] Task 6: Document Template Integration Patterns (AC: 1)
  - [ ] Analyze existing motion template patterns in `Clerk/src/ai_agents/motion_drafter.py` for reference
  - [ ] Document how Good Faith Letters use BMad template system as the first production implementation
  - [ ] Create integration guide for future migration of motion templates to BMad system
  - [ ] Share common template utilities where applicable (formatting, variable substitution)
  - [ ] Note: This task documents patterns only - does not modify existing motion drafter

- [ ] Task 7: Add Template Compliance Validation (AC: 4, 5)
  - [ ] Store compliance rules in template metadata under 'compliance_rules' section
  - [ ] Create compliance rules for each jurisdiction:
    - [ ] Federal: Must include case caption, parties, case number, meet and confer language
    - [ ] California: CCP 2031.310 requirements, 45-day response deadline
    - [ ] Florida: Rule 1.380 compliance, reasonable time provision
    - [ ] Texas: TRCP 215.2 requirements, authentication statement
  - [ ] Implement validation to ensure required sections exist:
    - [ ] Case caption section (required)
    - [ ] Deficiency summary section (required)
    - [ ] Legal basis section (required)
    - [ ] Request for action section (required)
    - [ ] Deadline/response timeframe section (required)
    - [ ] Signature block section (required)
  - [ ] Add variable validation:
    - [ ] All required variables must be defined in template
    - [ ] Variable names must follow UPPERCASE_UNDERSCORE pattern in YAML definition
    - [ ] Variables are used with {{VARIABLE_NAME}} syntax in template text
    - [ ] No template text outside of defined sections
  - [ ] Add warning system for outdated templates (version checking)
  - [ ] Create tests for compliance validation

- [ ] Task 8: Create Template Documentation and Examples (AC: All)
  - [ ] Document template system architecture
  - [ ] Create template authoring guide
  - [ ] Add examples of template customization
  - [ ] Update CLAUDE.md with template patterns

## Dev Notes

### Previous Story Insights
From Story 1.7 (Frontend Components):
- Material-UI v5 is used for UI components
- Redux Toolkit is used for state management
- WebSocket infrastructure provides real-time updates
- Case isolation is enforced throughout the system
- Comprehensive testing with React Testing Library is standard

### Architecture References

#### Template System Architecture
[Source: docs/architecture/unified-project-structure.md#bmad-framework-integration]
Templates are stored in the BMad framework directory structure:
```
Clerk/src/ai_agents/bmad_framework/templates/
├── motion-tmpl.yaml
├── deficiency-report-tmpl.yaml
└── (new) good-faith-letter-*.yaml templates
```

#### Existing Template Infrastructure
[Source: Existing codebase analysis]
- `TemplateLoader` class in `Clerk/src/ai_agents/bmad_framework/template_loader.py`
- Support for YAML templates with metadata, sections, variables, and validation
- Template caching mechanism already implemented
- `DocumentTemplate` and `TemplateSection` data classes define structure
- Support for multiple output formats (PDF, DOCX, Markdown)

#### GoodFaithLetterTemplateLoader Implementation Details
[Source: Based on existing TemplateLoader pattern]
```python
class GoodFaithLetterTemplateLoader(TemplateLoader):
    """Specialized loader for Good Faith letter templates with jurisdiction support."""
    
    def __init__(self):
        super().__init__(template_dir="templates/good-faith-letters")
        self.jurisdiction_map = {
            "federal": "good-faith-letter-federal.yaml",
            "california": "good-faith-letter-california.yaml", 
            "florida": "good-faith-letter-florida.yaml",
            "texas": "good-faith-letter-texas.yaml"
        }
    
    async def load_template_by_jurisdiction(self, jurisdiction: str) -> DocumentTemplate:
        """Load template for specific jurisdiction."""
        template_file = self.jurisdiction_map.get(jurisdiction.lower())
        if not template_file:
            raise ValidationError(f"No template found for jurisdiction: {jurisdiction}")
        return await self.load_template(template_file)
    
    def validate_template_compliance(self, template: DocumentTemplate) -> List[str]:
        """Validate template meets legal requirements."""
        errors = []
        required_sections = ["caption", "deficiency_summary", "legal_basis", 
                           "request_for_action", "signature_block"]
        
        template_sections = [s.name for s in template.sections]
        for req_section in required_sections:
            if req_section not in template_sections:
                errors.append(f"Missing required section: {req_section}")
        
        # Validate jurisdiction-specific rules
        if template.jurisdiction == "california":
            # Check for CCP 2031.310 compliance
            if "45-day" not in str(template.sections):
                errors.append("California template must mention 45-day deadline")
                
        return errors
```

#### Template Structure Pattern
[Source: Existing template files + Good Faith Letter requirements]
```yaml
metadata:
  type: legal_document
  subtype: good_faith_letter
  jurisdiction: federal
  version: "1.0"
  title: Good Faith Letter - Federal
  compliance_rules:
    - frcp_rule_37
    - local_meet_confer_requirements
  
document_settings:
  font: Times New Roman
  font_size: 12
  margins: standard_legal
  line_spacing: double
  
sections:
  - name: caption
    required: true
    order: 1
    template: |
      {{COURT_NAME}}
      {{JURISDICTION}}
      
      {{PLAINTIFF_NAME}},
                        Plaintiff,
      v.                            Case No. {{CASE_NUMBER}}
      {{DEFENDANT_NAME}},
                        Defendant.
    variables:  # Variables defined without brackets
      - COURT_NAME
      - JURISDICTION
      - PLAINTIFF_NAME
      - DEFENDANT_NAME
      - CASE_NUMBER
      
  - name: deficiency_summary
    required: true
    order: 2
    template: |
      Dear {{OPPOSING_COUNSEL_NAME}}:
      
      This letter addresses deficiencies in {{PRODUCING_PARTY}}'s discovery 
      production dated {{PRODUCTION_DATE}} in response to {{REQUESTING_PARTY}}'s 
      {{REQUEST_TYPE}} dated {{REQUEST_DATE}}.
      
      Summary of Deficiencies:
      {{DEFICIENCY_COUNT}} requests were not fully satisfied
      {{DOCUMENTS_MISSING}} documents appear to be missing
      {{PRIVILEGE_ISSUES}} privilege log issues identified
    variables:
      - OPPOSING_COUNSEL_NAME
      - PRODUCING_PARTY
      - PRODUCTION_DATE
      - REQUESTING_PARTY
      - REQUEST_TYPE
      - REQUEST_DATE
      - DEFICIENCY_COUNT
      - DOCUMENTS_MISSING
      - PRIVILEGE_ISSUES
      
  - name: legal_basis
    required: true
    order: 3
    template: |
      Under {{APPLICABLE_RULE}}, parties have a duty to respond fully to 
      discovery requests. The production falls short of this obligation
      for the reasons detailed below.
    variables:
      - APPLICABLE_RULE
      
  - name: detailed_deficiencies
    required: true
    order: 4
    repeatable: true  # One per deficient request
    template: |
      Request No. {{REQUEST_NUMBER}}: {{REQUEST_TEXT}}
      
      Deficiency: {{DEFICIENCY_DESCRIPTION}}
      
      Required Action: {{REQUIRED_ACTION}}
    variables:
      - REQUEST_NUMBER
      - REQUEST_TEXT  
      - DEFICIENCY_DESCRIPTION
      - REQUIRED_ACTION
      
  - name: request_for_action
    required: true
    order: 5
    template: |
      We request that you supplement your production to address these
      deficiencies within {{RESPONSE_DEADLINE}} days of this letter.
      
      Please contact me at {{CONTACT_INFO}} to discuss these issues and
      avoid the need for court intervention.
    variables:
      - RESPONSE_DEADLINE
      - CONTACT_INFO
      
  - name: signature_block
    required: true
    order: 6
    template: |
      Sincerely,
      
      {{ATTORNEY_NAME}}
      {{ATTORNEY_TITLE}}
      {{LAW_FIRM}}
      {{ADDRESS}}
      {{PHONE}}
      {{EMAIL}}
      
      Dated: {{DATE}}
    variables:
      - ATTORNEY_NAME
      - ATTORNEY_TITLE
      - LAW_FIRM
      - ADDRESS
      - PHONE
      - EMAIL
      - DATE

validation_rules:
  required_variables: # All must be provided when rendering
    - COURT_NAME
    - CASE_NUMBER
    - All section variables marked in template
  conditional_sections:
    - name: privilege_log_deficiencies
      condition: "PRIVILEGE_ISSUES > 0"
  formatting:
    - variable_pattern: "^[A-Z][A-Z_]*$"  # Variables defined as VARIABLE_NAME (no brackets)
    - template_syntax: "{{VARIABLE_NAME}}"  # Variables used as {{VARIABLE_NAME}} in template text
    - no_template_text_outside_sections: true
```

#### Service Layer Patterns
[Source: docs/architecture/coding-standards.md]
- Services follow single responsibility principle
- Use dependency injection for external dependencies
- Implement proper error handling and logging
- Case isolation must be enforced in all operations
- Services should be under 50 lines where possible
- LetterTemplateService will integrate with DeficiencyService by:
  - Accepting DeficiencyReport data for template population
  - Using deficiency items to fill detailed_deficiencies sections
  - Calculating response deadlines based on jurisdiction rules

#### API Design Patterns
[Source: docs/architecture/api-design.md]
- RESTful endpoints with proper HTTP verbs
- Pydantic models for request/response validation
- Case context from middleware via `get_case_context`
- Consistent error response format
- WebSocket events for long-running operations

#### File Locations
[Source: docs/architecture/unified-project-structure.md]
- Template files: `src/ai_agents/bmad_framework/templates/good-faith-letter-*.yaml`
- Service: `src/services/letter_template_service.py`
- API endpoints: Add to existing `src/api/deficiency_endpoints.py` (not a new file)
- Tests: Co-located in `tests/` subdirectories
- Models: Add to `src/models/deficiency_models.py`

#### Integration Points
[Source: Existing codebase]
- Motion drafter currently uses inline templates, not the BMad template system
- Task 6 will create a pattern for future template integration, not modify existing motion drafter
- The Good Faith Letter system will be the first production use of BMad template infrastructure
- Deficiency service exists but is mostly stubbed
- BMad framework provides template infrastructure via `TemplateLoader` class
- No existing Good Faith Letter functionality

#### Security Considerations
[Source: CLAUDE.md#critical-security-requirements]
- Case Isolation: Every operation MUST include case_name filter
- API Security: Never log sensitive template data
- Template Security: Templates can be global or case-specific
- Permission checking required for template modifications

#### Technical Constraints
[Source: CLAUDE.md#code-goals-modularity]
- Functions should be under 50 lines
- Files should be under 500 lines
- KISS principle - keep solutions simple
- YAGNI - only build what's needed now
- Always include proper error handling

### Testing

**Testing Standards from Architecture:**
[Source: docs/architecture/testing-strategy.md]
- Test framework: pytest for Python code
- Test file location: Co-located with code in `tests/` folders
- Coverage target: 80%+ for new code
- Mock external dependencies
- Test patterns:
  ```python
  @pytest.mark.asyncio
  async def test_template_loading():
      loader = GoodFaithLetterTemplateLoader()
      template = await loader.load_template("federal")
      assert template.metadata.jurisdiction == "federal"
  ```

**Key Test Scenarios:**
- Template loading with various jurisdictions
- Variable substitution and rendering
- Template validation and compliance checking
- API endpoint authorization and case isolation
- Caching behavior and performance
- Error handling for missing/invalid templates

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-07-21 | 1.0 | Initial story creation | Bob (Scrum Master) |
| 2025-07-21 | 1.1 | Fixed path errors, added validation rules, clarified integration, added example template | BMad Master |
| 2025-07-21 | 1.2 | Fixed all paths to use Clerk/src prefix, clarified API endpoint location, standardized template variable syntax to {{VAR}}, added service integration details | BMad Master |
| 2025-07-21 | 1.3 | Fixed critical issues: clarified API endpoints go in existing deficiency_endpoints.py, clarified template variable syntax (defined without brackets, used with {{}} in templates) | BMad Master |

## Dev Agent Record
### Agent Model Used
(To be filled by Dev Agent)

### Debug Log References
(To be filled by Dev Agent)

### Completion Notes List
(To be filled by Dev Agent)

### File List
(To be filled by Dev Agent)

## QA Results
(To be filled by QA Agent)