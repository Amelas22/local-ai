<!DOCTYPE html>
<html>
<head>
    <title>Simple WebSocket Test - Through Caddy</title>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test { margin: 20px 0; padding: 10px; border: 1px solid #ccc; }
        .success { background-color: #d4edda; }
        .error { background-color: #f8d7da; }
        .info { background-color: #d1ecf1; }
        pre { background-color: #f4f4f4; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>WebSocket Connection Test - Through Caddy Proxy</h1>
    
    <div class="test">
        <h2>Test 1: Using Current Window Location (Recommended for Caddy)</h2>
        <div id="test1-status">Waiting...</div>
        <pre id="test1-log"></pre>
    </div>
    
    <div class="test">
        <h2>Test 2: Using Explicit localhost:8010</h2>
        <div id="test2-status">Waiting...</div>
        <pre id="test2-log"></pre>
    </div>
    
    <div class="test">
        <h2>Test 3: Direct Backend Connection (localhost:8000)</h2>
        <div id="test3-status">Waiting...</div>
        <pre id="test3-log"></pre>
    </div>
    
    <script>
        function testConnection(testId, url, description) {
            const statusDiv = document.getElementById(`${testId}-status`);
            const logDiv = document.getElementById(`${testId}-log`);
            
            function log(msg) {
                logDiv.textContent += `[${new Date().toISOString()}] ${msg}\n`;
            }
            
            log(`Starting test: ${description}`);
            log(`URL: ${url}`);
            log(`Path: /ws/socket.io/`);
            
            const socket = io(url, {
                path: '/ws/socket.io/',
                transports: ['websocket', 'polling'],
                auth: { token: 'test-token' }
            });
            
            socket.on('connect', () => {
                statusDiv.textContent = '✅ Connected!';
                statusDiv.className = 'success';
                log(`Connected! Session ID: ${socket.id}`);
            });
            
            socket.on('connected', (data) => {
                log(`Received 'connected' event: ${JSON.stringify(data)}`);
            });
            
            socket.on('disconnect', (reason) => {
                statusDiv.textContent = `❌ Disconnected: ${reason}`;
                statusDiv.className = 'error';
                log(`Disconnected: ${reason}`);
            });
            
            socket.on('connect_error', (error) => {
                statusDiv.textContent = `❌ Connection Error: ${error.message}`;
                statusDiv.className = 'error';
                log(`Connection error: ${error.message}`);
                log(`Error type: ${error.type}`);
            });
            
            // Give it 5 seconds to connect
            setTimeout(() => {
                if (!socket.connected) {
                    statusDiv.textContent = '❌ Connection timeout';
                    statusDiv.className = 'error';
                    log('Connection timeout after 5 seconds');
                    socket.disconnect();
                }
            }, 5000);
            
            return socket;
        }
        
        // Test 1: Use current window location (best for production/Caddy)
        const protocol1 = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const url1 = `${protocol1}//${window.location.host}`;
        const socket1 = testConnection('test1', url1, 'Using current window location');
        
        // Test 2: Explicit localhost:8010 (Caddy proxy)
        const socket2 = testConnection('test2', 'ws://localhost:8010', 'Through Caddy proxy');
        
        // Test 3: Direct backend connection
        const socket3 = testConnection('test3', 'ws://localhost:8000', 'Direct to backend');
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            socket1.disconnect();
            socket2.disconnect();
            socket3.disconnect();
        });
    </script>
    
    <hr>
    <h2>How to use this test:</h2>
    <ol>
        <li>Open this file in your browser: <code>http://localhost:8010/test_websocket_simple.html</code></li>
        <li>The first test should work if Caddy is properly configured</li>
        <li>If Test 3 works but Test 1 & 2 don't, the issue is with Caddy proxy configuration</li>
        <li>If none work, the backend WebSocket server might not be running</li>
    </ol>
</body>
</html>